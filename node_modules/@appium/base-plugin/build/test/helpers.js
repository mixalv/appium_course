"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.e2eSetup = e2eSetup;

require("source-map-support/register");

var _support = require("@appium/support");

var _appium = require("appium");

var _getPort = _interopRequireDefault(require("get-port"));

var _logSymbols = require("log-symbols");

var _teen_process = require("teen_process");

const APPIUM_BIN = require.resolve('appium');

function e2eSetup(opts) {
  let {
    appiumHome,
    before,
    after,
    serverArgs = {},
    driverSource,
    driverPackage,
    driverName,
    driverSpec,
    pluginSource,
    pluginPackage,
    pluginSpec,
    pluginName,
    port,
    host
  } = opts;
  let server;
  before(async function () {
    const setupAppiumHome = async () => {
      const env = { ...process.env
      };

      if (appiumHome) {
        env.APPIUM_HOME = appiumHome;
        await _support.fs.mkdirp(appiumHome);
        console.log(`${_logSymbols.info} Set \`APPIUM_HOME\` to ${appiumHome}`);
      }

      return env;
    };

    const installDriver = async env => {
      var _installedDrivers$dri;

      console.log(`${_logSymbols.info} Checking if driver "${driverName}" is installed...`);
      const driverListArgs = [APPIUM_BIN, 'driver', 'list', '--json'];
      console.log(`${_logSymbols.info} Running: ${process.execPath} ${driverListArgs.join(' ')}`);
      const {
        stdout: driverListJson
      } = await (0, _teen_process.exec)(process.execPath, driverListArgs, {
        env
      });
      const installedDrivers = JSON.parse(driverListJson);

      if (!((_installedDrivers$dri = installedDrivers[driverName]) !== null && _installedDrivers$dri !== void 0 && _installedDrivers$dri.installed)) {
        console.log(`${_logSymbols.warning} Driver "${driverName}" not installed; installing...`);
        const driverArgs = [APPIUM_BIN, 'driver', 'install', '--source', driverSource, driverSpec];

        if (driverPackage) {
          driverArgs.push('--package', driverPackage);
        }

        console.log(`${_logSymbols.info} Running: ${process.execPath} ${driverArgs.join(' ')}`);
        await (0, _teen_process.exec)(process.execPath, driverArgs, {
          env
        });
      }

      console.log(`${_logSymbols.success} Installed driver "${driverName}"`);
    };

    const installPlugin = async env => {
      var _installedPlugins$plu;

      console.log(`${_logSymbols.info} Checking if plugin "${pluginName}" is installed...`);
      const pluginListArgs = [APPIUM_BIN, 'plugin', 'list', '--json'];
      const {
        stdout: pluginListJson
      } = await (0, _teen_process.exec)(process.execPath, pluginListArgs, {
        env
      });
      const installedPlugins = JSON.parse(pluginListJson);

      if (!((_installedPlugins$plu = installedPlugins[pluginName]) !== null && _installedPlugins$plu !== void 0 && _installedPlugins$plu.installed)) {
        console.log(`${_logSymbols.warning} Plugin "${pluginName}" not installed; installing...`);
        const pluginArgs = [APPIUM_BIN, 'plugin', 'install', '--source', pluginSource, pluginSpec];

        if (pluginPackage) {
          pluginArgs.push('--package', pluginPackage);
        }

        console.log(`${_logSymbols.info} Running: ${process.execPath} ${pluginArgs.join(' ')}`);
        await (0, _teen_process.exec)(process.execPath, pluginArgs, {
          env
        });
      }

      console.log(`${_logSymbols.success} Installed plugin "${pluginName}"`);
    };

    const createServer = async () => {
      if (!port) {
        port = await (0, _getPort.default)();
      }

      console.log(`${_logSymbols.info} Will use port ${port} for Appium server`);
      this.port = port;
      const args = {
        port,
        address: host,
        usePlugins: [pluginName],
        useDrivers: [driverName],
        appiumHome,
        ...serverArgs
      };
      server = await (0, _appium.main)(args);
    };

    const env = await setupAppiumHome();
    await installDriver(env);
    await installPlugin(env);
    await createServer();
  });
  after(async function () {
    if (server) {
      await server.close();
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3Rlc3QvaGVscGVycy5qcyJdLCJuYW1lcyI6WyJBUFBJVU1fQklOIiwicmVxdWlyZSIsInJlc29sdmUiLCJlMmVTZXR1cCIsIm9wdHMiLCJhcHBpdW1Ib21lIiwiYmVmb3JlIiwiYWZ0ZXIiLCJzZXJ2ZXJBcmdzIiwiZHJpdmVyU291cmNlIiwiZHJpdmVyUGFja2FnZSIsImRyaXZlck5hbWUiLCJkcml2ZXJTcGVjIiwicGx1Z2luU291cmNlIiwicGx1Z2luUGFja2FnZSIsInBsdWdpblNwZWMiLCJwbHVnaW5OYW1lIiwicG9ydCIsImhvc3QiLCJzZXJ2ZXIiLCJzZXR1cEFwcGl1bUhvbWUiLCJlbnYiLCJwcm9jZXNzIiwiQVBQSVVNX0hPTUUiLCJmcyIsIm1rZGlycCIsImNvbnNvbGUiLCJsb2ciLCJpbmZvIiwiaW5zdGFsbERyaXZlciIsImRyaXZlckxpc3RBcmdzIiwiZXhlY1BhdGgiLCJqb2luIiwic3Rkb3V0IiwiZHJpdmVyTGlzdEpzb24iLCJpbnN0YWxsZWREcml2ZXJzIiwiSlNPTiIsInBhcnNlIiwiaW5zdGFsbGVkIiwid2FybmluZyIsImRyaXZlckFyZ3MiLCJwdXNoIiwic3VjY2VzcyIsImluc3RhbGxQbHVnaW4iLCJwbHVnaW5MaXN0QXJncyIsInBsdWdpbkxpc3RKc29uIiwiaW5zdGFsbGVkUGx1Z2lucyIsInBsdWdpbkFyZ3MiLCJjcmVhdGVTZXJ2ZXIiLCJhcmdzIiwiYWRkcmVzcyIsInVzZVBsdWdpbnMiLCJ1c2VEcml2ZXJzIiwiY2xvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUNDLE9BQVIsQ0FBZ0IsUUFBaEIsQ0FBbkI7O0FBT0EsU0FBU0MsUUFBVCxDQUFtQkMsSUFBbkIsRUFBeUI7QUFDdkIsTUFBSTtBQUNGQyxJQUFBQSxVQURFO0FBRUZDLElBQUFBLE1BRkU7QUFHRkMsSUFBQUEsS0FIRTtBQUlGQyxJ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UyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxHQUFFQyxnQkFBSyxrQkFBaUJYLElBQUssb0JBQTFDO0FBQ0EsV0FBS0EsSUFBTCxHQUFZQSxJQUFaO0FBR0EsWUFBTWdDLElBQUksR0FBRztBQUNYaEMsUUFBQUEsSUFEVztBQUVYaUMsUUFBQUEsT0FBTyxFQUFFaEMsSUFGRTtBQUdYaUMsUUFBQUEsVUFBVSxFQUFFLENBQUNuQyxVQUFELENBSEQ7QUFJWG9DLFFBQUFBLFVBQVUsRUFBRSxDQUFDekMsVUFBRCxDQUpEO0FBS1hOLFFBQUFBLFVBTFc7QUFNWCxXQUFHRztBQU5RLE9BQWI7QUFRQVcsTUFBQUEsTUFBTSxHQUErQixNQUFNLGtCQUFhOEIsSUFBYixDQUEzQztBQUNELEtBakJEOztBQW1CQSxVQUFNNUIsR0FBRyxHQUFHLE1BQU1ELGVBQWUsRUFBakM7QUFDQSxVQUFNUyxhQUFhLENBQUNSLEdBQUQsQ0FBbkI7QUFDQSxVQUFNc0IsYUFBYSxDQUFDdEIsR0FBRCxDQUFuQjtBQUNBLFVBQU0yQixZQUFZLEVBQWxCO0FBQ0QsR0E1SEssQ0FBTjtBQThIQXpDLEVBQUFBLEtBQUssQ0FBQyxrQkFBa0I7QUFDdEIsUUFBSVksTUFBSixFQUFZO0FBQ1YsWUFBTUEsTUFBTSxDQUFDa0MsS0FBUCxFQUFOO0FBQ0Q7QUFDRixHQUpJLENBQUw7QUFLRCIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gQHRzLWNoZWNrXG5cbi8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbmltcG9ydCB7IGZzIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IG1haW4gYXMgYXBwaXVtU2VydmVyIH0gZnJvbSAnYXBwaXVtJztcbmltcG9ydCBnZXRQb3J0IGZyb20gJ2dldC1wb3J0JztcbmltcG9ydCB7IGluZm8sIHN1Y2Nlc3MsIHdhcm5pbmcgfSBmcm9tICdsb2ctc3ltYm9scyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxuY29uc3QgQVBQSVVNX0JJTiA9IHJlcXVpcmUucmVzb2x2ZSgnYXBwaXVtJyk7XG5cbi8qKlxuICogQ3JlYXRlcyBob29rcyB0byBpbnN0YWxsIGEgZHJpdmVyIGFuZCBhIHBsdWdpbiBhbmQgc3RhcnRzIGFuIEFwcGl1bSBzZXJ2ZXIgdy8gdGhlIGdpdmVuIGV4dGVuc2lvbnMuXG4gKiBAcGFyYW0ge0UyRVNldHVwT3B0c30gb3B0c1xuICogQHJldHVybnMge3ZvaWR9XG4gKi9cbmZ1bmN0aW9uIGUyZVNldHVwIChvcHRzKSB7XG4gIGxldCB7XG4gICAgYXBwaXVtSG9tZSxcbiAgICBiZWZvcmUsXG4gICAgYWZ0ZXIsXG4gICAgc2VydmVyQXJncyA9IHt9LFxuICAgIGRyaXZlclNvdXJjZSxcbiAgICBkcml2ZXJQYWNrYWdlLFxuICAgIGRyaXZlck5hbWUsXG4gICAgZHJpdmVyU3BlYyxcbiAgICBwbHVnaW5Tb3VyY2UsXG4gICAgcGx1Z2luUGFja2FnZSxcbiAgICBwbHVnaW5TcGVjLFxuICAgIHBsdWdpbk5hbWUsXG4gICAgcG9ydCxcbiAgICBob3N0LFxuICB9ID0gb3B0cztcblxuICAvKipcbiAgICogQHR5cGUge0FwcGl1bVNlcnZlcn1cbiAgICovXG4gIGxldCBzZXJ2ZXI7XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBzZXR1cEFwcGl1bUhvbWUgPSBhc3luYyAoKSA9PiB7XG4gICAgICAvKipcbiAgICAgICAqIEB0eXBlIHtBcHBpdW1FbnZ9XG4gICAgICAgKi9cbiAgICAgIGNvbnN0IGVudiA9IHsuLi5wcm9jZXNzLmVudn07XG5cbiAgICAgIGlmIChhcHBpdW1Ib21lKSB7XG4gICAgICAgIGVudi5BUFBJVU1fSE9NRSA9IGFwcGl1bUhvbWU7XG4gICAgICAgIGF3YWl0IGZzLm1rZGlycChhcHBpdW1Ib21lKTtcbiAgICAgICAgY29uc29sZS5sb2coYCR7aW5mb30gU2V0IFxcYEFQUElVTV9IT01FXFxgIHRvICR7YXBwaXVtSG9tZX1gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGVudjtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0FwcGl1bUVudn0gZW52XG4gICAgICovXG4gICAgY29uc3QgaW5zdGFsbERyaXZlciA9IGFzeW5jIChlbnYpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGAke2luZm99IENoZWNraW5nIGlmIGRyaXZlciBcIiR7ZHJpdmVyTmFtZX1cIiBpcyBpbnN0YWxsZWQuLi5gKTtcbiAgICAgIGNvbnN0IGRyaXZlckxpc3RBcmdzID0gW0FQUElVTV9CSU4sICdkcml2ZXInLCAnbGlzdCcsICctLWpzb24nXTtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgJHtpbmZvfSBSdW5uaW5nOiAke3Byb2Nlc3MuZXhlY1BhdGh9ICR7ZHJpdmVyTGlzdEFyZ3Muam9pbignICcpfWAsXG4gICAgICApO1xuICAgICAgY29uc3Qge3N0ZG91dDogZHJpdmVyTGlzdEpzb259ID0gYXdhaXQgZXhlYyhcbiAgICAgICAgcHJvY2Vzcy5leGVjUGF0aCxcbiAgICAgICAgZHJpdmVyTGlzdEFyZ3MsXG4gICAgICAgIHtcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgY29uc3QgaW5zdGFsbGVkRHJpdmVycyA9IEpTT04ucGFyc2UoZHJpdmVyTGlzdEpzb24pO1xuXG4gICAgICBpZiAoIWluc3RhbGxlZERyaXZlcnNbZHJpdmVyTmFtZV0/Lmluc3RhbGxlZCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgJHt3YXJuaW5nfSBEcml2ZXIgXCIke2RyaXZlck5hbWV9XCIgbm90IGluc3RhbGxlZDsgaW5zdGFsbGluZy4uLmAsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGRyaXZlckFyZ3MgPSBbXG4gICAgICAgICAgQVBQSVVNX0JJTixcbiAgICAgICAgICAnZHJpdmVyJyxcbiAgICAgICAgICAnaW5zdGFsbCcsXG4gICAgICAgICAgJy0tc291cmNlJyxcbiAgICAgICAgICBkcml2ZXJTb3VyY2UsXG4gICAgICAgICAgZHJpdmVyU3BlYyxcbiAgICAgICAgXTtcbiAgICAgICAgaWYgKGRyaXZlclBhY2thZ2UpIHtcbiAgICAgICAgICBkcml2ZXJBcmdzLnB1c2goJy0tcGFja2FnZScsIGRyaXZlclBhY2thZ2UpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGAke2luZm99IFJ1bm5pbmc6ICR7cHJvY2Vzcy5leGVjUGF0aH0gJHtkcml2ZXJBcmdzLmpvaW4oJyAnKX1gLFxuICAgICAgICApO1xuICAgICAgICBhd2FpdCBleGVjKHByb2Nlc3MuZXhlY1BhdGgsIGRyaXZlckFyZ3MsIHtcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coYCR7c3VjY2Vzc30gSW5zdGFsbGVkIGRyaXZlciBcIiR7ZHJpdmVyTmFtZX1cImApO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7QXBwaXVtRW52fSBlbnZcbiAgICAgKi9cbiAgICBjb25zdCBpbnN0YWxsUGx1Z2luID0gYXN5bmMgKGVudikgPT4ge1xuICAgICAgY29uc29sZS5sb2coYCR7aW5mb30gQ2hlY2tpbmcgaWYgcGx1Z2luIFwiJHtwbHVnaW5OYW1lfVwiIGlzIGluc3RhbGxlZC4uLmApO1xuICAgICAgY29uc3QgcGx1Z2luTGlzdEFyZ3MgPSBbQVBQSVVNX0JJTiwgJ3BsdWdpbicsICdsaXN0JywgJy0tanNvbiddO1xuICAgICAgY29uc3Qge3N0ZG91dDogcGx1Z2luTGlzdEpzb259ID0gYXdhaXQgZXhlYyhcbiAgICAgICAgcHJvY2Vzcy5leGVjUGF0aCxcbiAgICAgICAgcGx1Z2luTGlzdEFyZ3MsXG4gICAgICAgIHtcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgY29uc3QgaW5zdGFsbGVkUGx1Z2lucyA9IEpTT04ucGFyc2UocGx1Z2luTGlzdEpzb24pO1xuXG4gICAgICBpZiAoIWluc3RhbGxlZFBsdWdpbnNbcGx1Z2luTmFtZV0/Lmluc3RhbGxlZCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgJHt3YXJuaW5nfSBQbHVnaW4gXCIke3BsdWdpbk5hbWV9XCIgbm90IGluc3RhbGxlZDsgaW5zdGFsbGluZy4uLmAsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHBsdWdpbkFyZ3MgPSBbXG4gICAgICAgICAgQVBQSVVNX0JJTixcbiAgICAgICAgICAncGx1Z2luJyxcbiAgICAgICAgICAnaW5zdGFsbCcsXG4gICAgICAgICAgJy0tc291cmNlJyxcbiAgICAgICAgICBwbHVnaW5Tb3VyY2UsXG4gICAgICAgICAgcGx1Z2luU3BlYyxcbiAgICAgICAgXTtcbiAgICAgICAgaWYgKHBsdWdpblBhY2thZ2UpIHtcbiAgICAgICAgICBwbHVnaW5BcmdzLnB1c2goJy0tcGFja2FnZScsIHBsdWdpblBhY2thZ2UpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGAke2luZm99IFJ1bm5pbmc6ICR7cHJvY2Vzcy5leGVjUGF0aH0gJHtwbHVnaW5BcmdzLmpvaW4oJyAnKX1gLFxuICAgICAgICApO1xuICAgICAgICBhd2FpdCBleGVjKHByb2Nlc3MuZXhlY1BhdGgsIHBsdWdpbkFyZ3MsIHtcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coYCR7c3VjY2Vzc30gSW5zdGFsbGVkIHBsdWdpbiBcIiR7cGx1Z2luTmFtZX1cImApO1xuICAgIH07XG5cbiAgICBjb25zdCBjcmVhdGVTZXJ2ZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoIXBvcnQpIHtcbiAgICAgICAgcG9ydCA9IGF3YWl0IGdldFBvcnQoKTtcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKGAke2luZm99IFdpbGwgdXNlIHBvcnQgJHtwb3J0fSBmb3IgQXBwaXVtIHNlcnZlcmApO1xuICAgICAgdGhpcy5wb3J0ID0gcG9ydDtcblxuICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJ2FwcGl1bScpLkFyZ3N9ICovXG4gICAgICBjb25zdCBhcmdzID0ge1xuICAgICAgICBwb3J0LFxuICAgICAgICBhZGRyZXNzOiBob3N0LFxuICAgICAgICB1c2VQbHVnaW5zOiBbcGx1Z2luTmFtZV0sXG4gICAgICAgIHVzZURyaXZlcnM6IFtkcml2ZXJOYW1lXSxcbiAgICAgICAgYXBwaXVtSG9tZSxcbiAgICAgICAgLi4uc2VydmVyQXJnc1xuICAgICAgfTtcbiAgICAgIHNlcnZlciA9IC8qKiBAdHlwZSB7QXBwaXVtU2VydmVyfSAqLyhhd2FpdCBhcHBpdW1TZXJ2ZXIoYXJncykpO1xuICAgIH07XG5cbiAgICBjb25zdCBlbnYgPSBhd2FpdCBzZXR1cEFwcGl1bUhvbWUoKTtcbiAgICBhd2FpdCBpbnN0YWxsRHJpdmVyKGVudik7XG4gICAgYXdhaXQgaW5zdGFsbFBsdWdpbihlbnYpO1xuICAgIGF3YWl0IGNyZWF0ZVNlcnZlcigpO1xuICB9KTtcblxuICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHNlcnZlcikge1xuICAgICAgYXdhaXQgc2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IHsgZTJlU2V0dXAgfTtcblxuLyoqXG4gKiBAdHlwZWRlZiBFMkVTZXR1cE9wdHNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbYXBwaXVtSG9tZV0gLSBQYXRoIHRvIEFwcGl1bSBob21lIGRpcmVjdG9yeVxuICogQHByb3BlcnR5IHtNb2NoYS5iZWZvcmV9IGJlZm9yZSAtIE1vY2hhIFwiYmVmb3JlIGFsbFwiIGhvb2sgZnVuY3Rpb25cbiAqIEBwcm9wZXJ0eSB7TW9jaGEuYWZ0ZXJ9IGFmdGVyIC0gTW9jaGEgXCJhZnRlciBhbGxcIiBob29rIGZ1bmN0aW9uXG4gKiBAcHJvcGVydHkge1BhcnRpYWw8aW1wb3J0KCdhcHBpdW0nKS5BcmdzPn0gW3NlcnZlckFyZ3NdIC0gQXJndW1lbnRzIHRvIHBhc3MgdG8gQXBwaXVtIHNlcnZlclxuICogQHByb3BlcnR5IHtpbXBvcnQoJ2FwcGl1bS90eXBlcycpLkluc3RhbGxUeXBlICYgc3RyaW5nfSBbZHJpdmVyU291cmNlXSAtIFNvdXJjZSBvZiBkcml2ZXIgdG8gaW5zdGFsbFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtkcml2ZXJQYWNrYWdlXSAtIFBhY2thZ2UgbmFtZSBvZiBkcml2ZXIgdG8gaW5zdGFsbFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtkcml2ZXJOYW1lXSAtIE5hbWUgb2YgZHJpdmVyIHRvIGluc3RhbGxcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbZHJpdmVyU3BlY10gLSBTcGVjIG9mIGRyaXZlciB0byBpbnN0YWxsXG4gKiBAcHJvcGVydHkge2ltcG9ydCgnYXBwaXVtL3R5cGVzJykuSW5zdGFsbFR5cGUgJiBzdHJpbmd9IFtwbHVnaW5Tb3VyY2VdIC0gU291cmNlIG9mIHBsdWdpbiB0byBpbnN0YWxsXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW3BsdWdpblBhY2thZ2VdIC0gUGFja2FnZSBuYW1lIG9mIHBsdWdpbiB0byBpbnN0YWxsXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW3BsdWdpblNwZWNdIC0gU3BlYyBvZiBwbHVnaW4gdG8gaW5zdGFsbFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtwbHVnaW5OYW1lXSAtIE5hbWUgb2YgcGx1Z2luIHRvIGluc3RhbGxcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbcG9ydF0gLSBQb3J0IHRvIHVzZSBmb3IgQXBwaXVtIHNlcnZlclxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtob3N0XSAtIEhvc3QgdG8gdXNlIGZvciBBcHBpdW0gc2VydmVyXG4gKi9cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtpbXBvcnQoJ0BhcHBpdW0vdHlwZXMnKS5BcHBpdW1TZXJ2ZXJ9IEFwcGl1bVNlcnZlclxuICovXG4vKipcbiAqIEB0eXBlZGVmIHtpbXBvcnQoJ2FwcGl1bS90eXBlcycpLkFwcGl1bUVudn0gQXBwaXVtRW52XG4gKi9cbiJdfQ==