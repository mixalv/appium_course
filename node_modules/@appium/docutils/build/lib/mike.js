"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mike = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

const DEFAULT_REMOTE = 'origin';
const DEFAULT_BRANCH = 'gh-pages';
const MIKE_VER_STRING = 'mike 1.';

class Mike {
  remote;
  branch;
  prefix;
  configFile;
  _mikeVerified = false;

  constructor(opts) {
    this.remote = opts.remote || DEFAULT_REMOTE;
    this.branch = opts.branch || DEFAULT_BRANCH;
    this.prefix = opts.prefix;
    this.configFile = opts.configFile;
  }

  async verifyMike() {
    if (this._mikeVerified) {
      return;
    }

    try {
      const {
        stdout
      } = await this.exec('--version', [], false);

      if (!stdout.includes(MIKE_VER_STRING)) {
        throw new Error('Mike was installed but was not version 1.x');
      }
    } catch (err) {
      throw new Error(`Could not verify appropriate mike binary exists: ${err}`);
    }

    this._mikeVerified = true;
  }

  getMikeArgs(cmdName, cmdArgs) {
    return [cmdName, ...cmdArgs, '--config-file', this.configFile, '--remote', this.remote, '--branch', this.branch, '--prefix', this.prefix];
  }

  async exec(mikeCmd, mikeArgs = [], verify = true) {
    if (verify) {
      await this.verifyMike();
    }

    const args = this.getMikeArgs(mikeCmd, mikeArgs);

    _logger.default.debug(`Running mike ${args.join(' ')}`);

    return await (0, _teen_process.exec)('mike', args);
  }

  async list() {
    const {
      stdout
    } = await this.exec('list');
    return stdout.split('\n').map(s => s.trim()).filter(Boolean);
  }

  async setDefault(alias) {
    await this.exec('set-default', [alias]);
  }

  async deploy(opts) {
    const args = [opts.version];

    if (opts.alias) {
      args.push(opts.alias, '--update-aliases');
    }

    if (opts.shouldPush) {
      args.push('--push');
    }

    if (opts.shouldRebase) {
      args.push('--rebase');
    }

    if (opts.commit) {
      args.push('--message', opts.commit);
    }

    await this.exec('deploy', args);
  }

}

exports.Mike = Mike;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9taWtlLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfUkVNT1RFIiwiREVGQVVMVF9CUkFOQ0giLCJNSUtFX1ZFUl9TVFJJTkciLCJNaWtlIiwicmVtb3RlIiwiYnJhbmNoIiwicHJlZml4IiwiY29uZmlnRmlsZSIsIl9taWtlVmVyaWZpZWQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJ2ZXJpZnlNaWtlIiwic3Rkb3V0IiwiZXhlYyIsImluY2x1ZGVzIiwiRXJyb3IiLCJlcnIiLCJnZXRNaWtlQXJncyIsImNtZE5hbWUiLCJjbWRBcmdzIiwibWlrZUNtZCIsIm1pa2VBcmdzIiwidmVyaWZ5IiwiYXJncyIsImxvZyIsImRlYnVnIiwiam9pbiIsImxpc3QiLCJzcGxpdCIsIm1hcCIsInMiLCJ0cmltIiwiZmlsdGVyIiwiQm9vbGVhbiIsInNldERlZmF1bHQiLCJhbGlhcyIsImRlcGxveSIsInZlcnNpb24iLCJwdXNoIiwic2hvdWxkUHVzaCIsInNob3VsZFJlYmFzZSIsImNvbW1pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsUUFBdkI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsVUFBdkI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsU0FBeEI7O0FBRU8sTUFBTUMsSUFBTixDQUFXO0FBQ0lDLEVBQUFBLE1BQU07QUFDTkMsRUFBQUEsTUFBTTtBQUNMQyxFQUFBQSxNQUFNO0FBQ1BDLEVBQUFBLFVBQVU7QUFDVEMsRUFBQUEsYUFBYSxHQUFHLEtBQUg7O0FBRWxDQyxFQUFBQSxXQUFXLENBQXVCQyxJQUF2QixFQUE2QjtBQUN0QyxTQUFLTixNQUFMLEdBQWNNLElBQUksQ0FBQ04sTUFBTCxJQUFlSixjQUE3QjtBQUNBLFNBQUtLLE1BQUwsR0FBY0ssSUFBSSxDQUFDTCxNQUFMLElBQWVKLGNBQTdCO0FBQ0EsU0FBS0ssTUFBTCxHQUFjSSxJQUFJLENBQUNKLE1BQW5CO0FBQ0EsU0FBS0MsVUFBTCxH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cHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgREVGQVVMVF9SRU1PVEUgPSAnb3JpZ2luJztcbmNvbnN0IERFRkFVTFRfQlJBTkNIID0gJ2doLXBhZ2VzJztcbmNvbnN0IE1JS0VfVkVSX1NUUklORyA9ICdtaWtlIDEuJztcblxuZXhwb3J0IGNsYXNzIE1pa2Uge1xuICAvKiogQHR5cGUgc3RyaW5nICovIHJlbW90ZTtcbiAgLyoqIEB0eXBlIHN0cmluZyAqLyBicmFuY2g7XG4gIC8qKiBAdHlwZSBzdHJpbmc/ICovIHByZWZpeDtcbiAgLyoqIEB0eXBlIHN0cmluZyAqLyBjb25maWdGaWxlO1xuICAvKiogQHR5cGUgYm9vbGVhbiAqLyBfbWlrZVZlcmlmaWVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IgKC8qKiBAdHlwZSBNaWtlT3B0cyAqL29wdHMpIHtcbiAgICB0aGlzLnJlbW90ZSA9IG9wdHMucmVtb3RlIHx8IERFRkFVTFRfUkVNT1RFO1xuICAgIHRoaXMuYnJhbmNoID0gb3B0cy5icmFuY2ggfHwgREVGQVVMVF9CUkFOQ0g7XG4gICAgdGhpcy5wcmVmaXggPSBvcHRzLnByZWZpeDtcbiAgICB0aGlzLmNvbmZpZ0ZpbGUgPSBvcHRzLmNvbmZpZ0ZpbGU7XG4gIH1cblxuICAvKipcbiAgICogVGhyb3cgYW4gZXJyb3IgaWYgdGhlICdtaWtlJyBiaW5hcnkgY2Fubm90IGJlIGZvdW5kXG4gICAqXG4gICAqIEB0aHJvd3MgRXJyb3JcbiAgICovXG4gIGFzeW5jIHZlcmlmeU1pa2UgKCkge1xuICAgIGlmICh0aGlzLl9taWtlVmVyaWZpZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdGhpcy5leGVjKCctLXZlcnNpb24nLCBbXSwgZmFsc2UpO1xuICAgICAgaWYgKCFzdGRvdXQuaW5jbHVkZXMoTUlLRV9WRVJfU1RSSU5HKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pa2Ugd2FzIGluc3RhbGxlZCBidXQgd2FzIG5vdCB2ZXJzaW9uIDEueCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgdmVyaWZ5IGFwcHJvcHJpYXRlIG1pa2UgYmluYXJ5IGV4aXN0czogJHtlcnJ9YCk7XG4gICAgfVxuICAgIHRoaXMuX21pa2VWZXJpZmllZCA9IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIGFycmF5IG9mIGFyZ3MgYmFzZWQgb24gdGhlIGNsYXNzIG1lbWJlcnMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIE1pa2UtcmVsYXRlZCBzdWJwcm9jZXNzXG4gICAqIGV4ZWN1dGlvblxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY21kTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBtaWtlIGNvbW1hbmQgdG8gcnVuXG4gICAqIEBwYXJhbSB7c3RyaW5nW119IGNtZEFyZ3MgLSBhbiBhcnJheSBvZiBjb21tYW5kLXNwZWNpZmljIGFyZ3VtZW50c1xuICAgKlxuICAgKiBAcmV0dXJucyBzdHJpbmdbXVxuICAgKi9cbiAgZ2V0TWlrZUFyZ3MgKGNtZE5hbWUsIGNtZEFyZ3MpIHtcbiAgICByZXR1cm4gW1xuICAgICAgY21kTmFtZSwgLi4uY21kQXJncyxcbiAgICAgICctLWNvbmZpZy1maWxlJywgdGhpcy5jb25maWdGaWxlLFxuICAgICAgJy0tcmVtb3RlJywgdGhpcy5yZW1vdGUsXG4gICAgICAnLS1icmFuY2gnLCB0aGlzLmJyYW5jaCxcbiAgICAgICctLXByZWZpeCcsIHRoaXMucHJlZml4LFxuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogRXhlYyBtaWtlIGFzIGEgc3VicHJvY2Vzc1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbWlrZUNtZCAtIHRoZSBtaWtlIGNvbW1hbmQgdG8gcnVuXG4gICAqIEBwYXJhbSB7c3RyaW5nW119IFttaWtlQXJncz1bXV0gLSB0aGUgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIG1pa2UgY29tbWFuZFxuICAgKiBAcGFyYW0ge2Jvb2xlYW4/fSBbdmVyaWZ5PXRydWVdIC0gd2hldGhlciB0byB2ZXJpZnkgbWlrZSBleGlzdHMgZmlyc3RcbiAgICpcbiAgICogQHJldHVybnMgUHJvbWlzZTxpbXBvcnQoJ3RlZW5fcHJvY2VzcycpLkV4ZWNSZXN1bHQ8c3RyaW5nPj5cbiAgICovXG4gIGFzeW5jIGV4ZWMgKG1pa2VDbWQsIG1pa2VBcmdzID0gW10sIHZlcmlmeSA9IHRydWUpIHtcbiAgICBpZiAodmVyaWZ5KSB7XG4gICAgICBhd2FpdCB0aGlzLnZlcmlmeU1pa2UoKTtcbiAgICB9XG4gICAgY29uc3QgYXJncyA9IHRoaXMuZ2V0TWlrZUFyZ3MobWlrZUNtZCwgbWlrZUFyZ3MpO1xuICAgIGxvZy5kZWJ1ZyhgUnVubmluZyBtaWtlICR7YXJncy5qb2luKCcgJyl9YCk7XG4gICAgcmV0dXJuIGF3YWl0IGV4ZWMoJ21pa2UnLCBhcmdzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIGxpc3Qgb2YgbWlrZSBkZXBsb3lzXG4gICAqXG4gICAqIEByZXR1cm5zIHN0cmluZ1tdXG4gICAqL1xuICBhc3luYyBsaXN0ICgpIHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IHRoaXMuZXhlYygnbGlzdCcpO1xuICAgIHJldHVybiBzdGRvdXQuc3BsaXQoJ1xcbicpLm1hcCgocykgPT4gcy50cmltKCkpLmZpbHRlcihCb29sZWFuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGRlZmF1bHQgdmVyc2lvbiBvciBhbGlhc1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYWxpYXMgLSB0aGUgdmVyc2lvbiBvciBhbGlhc1xuICAgKi9cbiAgYXN5bmMgc2V0RGVmYXVsdCAoYWxpYXMpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWMoJ3NldC1kZWZhdWx0JywgW2FsaWFzXSk7XG4gIH1cblxuICAvKipcbiAgICogRGVwbG95IGRvY3MgdG8gdGhlIGJyYW5jaFxuICAgKlxuICAgKiBAcGFyYW0ge01pa2VEZXBsb3lPcHRzfSBvcHRzIC0gdGhlIGRlcGxveSBvcHRpb25zXG4gICAqL1xuICBhc3luYyBkZXBsb3kgKG9wdHMpIHtcbiAgICBjb25zdCBhcmdzID0gW29wdHMudmVyc2lvbl07XG4gICAgaWYgKG9wdHMuYWxpYXMpIHtcbiAgICAgIGFyZ3MucHVzaChvcHRzLmFsaWFzLCAnLS11cGRhdGUtYWxpYXNlcycpO1xuICAgIH1cbiAgICBpZiAob3B0cy5zaG91bGRQdXNoKSB7XG4gICAgICBhcmdzLnB1c2goJy0tcHVzaCcpO1xuICAgIH1cbiAgICBpZiAob3B0cy5zaG91bGRSZWJhc2UpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1yZWJhc2UnKTtcbiAgICB9XG4gICAgaWYgKG9wdHMuY29tbWl0KSB7XG4gICAgICBhcmdzLnB1c2goJy0tbWVzc2FnZScsIG9wdHMuY29tbWl0KTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5leGVjKCdkZXBsb3knLCBhcmdzKTtcbiAgfVxuXG59XG5cbi8qKlxuICogQHR5cGVkZWYgTWlrZU9wdHMgLSBvcHRpb25zIGZvciBpbnN0YW50aWF0aW5nIGEgTWlrZSBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbcmVtb3RlPVwib3JpZ2luXCJdIC0gdGhlIGdpdCByZW1vdGUgdG8gcHVzaCBkb2NzIHRvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW2JyYW5jaD1cImdoLXBhZ2VzXCJdIC0gdGhlIGdpdCBicmFuY2ggdG8gcHVzaCBkb2NzIHRvXG4gKiBAcHJvcGVydHkge3N0cmluZz99IHByZWZpeCAtIHRoZSBwYXRoIHByZWZpeCBvbiB0aGUgYnJhbmNoIGlmIGFueVxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbmZpZ0ZpbGUgLSB0aGUgbWtkb2NzIGNvbmZpZyBmaWxlIHRvIHVzZVxuICovXG5cbi8qKlxuICogQHR5cGVkZWYgTWlrZURlcGxveU9wdHMgLSBvcHRpb25zIGZvciBkZXBsb3lpbmcgZG9jcyB3aXRoIE1pa2VcbiAqIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIC0gdGhlIHZlcnNpb24gdG8gZGVwbG95XG4gKiBAcGFyYW0ge3N0cmluZz99IGFsaWFzIC0gdGhlIGFsaWFzIHRvIGFsaWFzIChvciByZS1hbGlhcykgdGhlIHZlcnNpb25cbiAqIEBwYXJhbSB7c3RyaW5nP30gY29tbWl0IC0gdGhlIGNvbW1pdCBtZXNzYWdlIHRvIHVzZSBhcyBhbiBvdmVycmlkZVxuICogQHBhcmFtIHtib29sZWFuP30gc2hvdWxkUHVzaCAtIHdoZXRoZXIgbWlrZSBzaG91bGQgcHVzaCB0aGUgY29tbWl0cyB0byB0aGUgcmVtb3RlXG4gKiBAcGFyYW0ge2Jvb2xlYW4/fSBzaG91bGRSZWJhc2UgLSB3aGV0aGVyIG1pa2Ugc2hvdWxkIHJlYmFzZVxuICovXG4iXX0=