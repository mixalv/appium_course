"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.formatErrors = formatErrors;
exports.normalizeConfig = normalizeConfig;
exports.readConfigFile = readConfigFile;

require("source-map-support/register");

var _betterAjvErrors = _interopRequireDefault(require("@sidvind/better-ajv-errors"));

var _lilconfig = require("lilconfig");

var _lodash = _interopRequireDefault(require("lodash"));

var _yaml = _interopRequireDefault(require("yaml"));

var _schema = require("./schema/schema");

function yamlLoader(filepath, content) {
  return _yaml.default.parse(content);
}

const rawConfig = new Map();

function jsonLoader(filepath, content) {
  rawConfig.set(filepath, content);
  return JSON.parse(content);
}

async function loadConfigFile(lc, filepath) {
  try {
    return await lc.load(filepath);
  } catch (err) {
    if (err.code === 'ENOENT') {
      err.message = `Config file not found at user-provided path: ${filepath}`;
      throw err;
    } else if (err instanceof SyntaxError) {
      err.message = `Config file at user-provided path ${filepath} is invalid:\n${err.message}`;
      throw err;
    }

    throw err;
  }
}

async function searchConfigFile(lc) {
  return await lc.search();
}

function formatErrors(errors = [], config = {}, opts = {}) {
  if (errors && !errors.length) {
    throw new TypeError('Array of errors must be non-empty');
  }

  return (0, _betterAjvErrors.default)((0, _schema.getSchema)(opts.schemaId), config, errors, {
    json: opts.json,
    format: 'cli'
  });
}

async function readConfigFile(filepath, opts = {}) {
  const lc = (0, _lilconfig.lilconfig)('appium', {
    loaders: {
      '.yaml': yamlLoader,
      '.yml': yamlLoader,
      '.json': jsonLoader,
      noExt: jsonLoader
    },
    packageProp: 'appiumConfig'
  });
  const result = filepath ? await loadConfigFile(lc, filepath) : await searchConfigFile(lc);

  if (result !== null && result !== void 0 && result.filepath && !(result !== null && result !== void 0 && result.isEmpty)) {
    const {
      pretty = true
    } = opts;

    try {
      let configResult;
      const errors = (0, _schema.validate)(result.config);

      if (_lodash.default.isEmpty(errors)) {
        configResult = { ...result,
          errors
        };
      } else {
        const reason = formatErrors(errors, result.config, {
          json: rawConfig.get(result.filepath),
          pretty
        });
        configResult = reason ? { ...result,
          errors,
          reason
        } : { ...result,
          errors
        };
      }

      configResult.config = normalizeConfig(configResult.config);
      return configResult;
    } finally {
      rawConfig.delete(result.filepath);
    }
  }

  return result !== null && result !== void 0 ? result : {};
}

function normalizeConfig(config) {
  const schema = (0, _schema.getSchema)();

  const normalize = (config, section) => {
    const obj = _lodash.default.isUndefined(section) ? config : _lodash.default.get(config, section, config);

    const mappedObj = _lodash.default.mapKeys(obj, (__, prop) => {
      var _schema$properties$pr, _schema$properties$pr2;

      return (_schema$properties$pr = (_schema$properties$pr2 = schema.properties[prop]) === null || _schema$properties$pr2 === void 0 ? void 0 : _schema$properties$pr2.appiumCliDest) !== null && _schema$properties$pr !== void 0 ? _schema$properties$pr : _lodash.default.camelCase(prop);
    });

    return _lodash.default.mapValues(mappedObj, (value, property) => {
      const nextSection = section ? `${section}.${property}` : property;
      return isSchemaTypeObject(value) ? normalize(config, nextSection) : value;
    });
  };

  const isSchemaTypeObject = schema => Boolean(schema.properties);

  return normalize(config);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb25maWctZmlsZS5qcyJdLCJuYW1lcyI6WyJ5YW1sTG9hZGVyIiwiZmlsZXBhdGgiLCJjb250ZW50IiwieWFtbCIsInBhcnNlIiwicmF3Q29uZmlnIiwiTWFwIiwianNvbkxvYWRlciIsInNldCIsIkpTT04iLCJsb2FkQ29uZmlnRmlsZSIsImxjIiwibG9hZCIsImVyciIsImNvZGUiLCJtZXNzYWdlIiwiU3ludGF4RXJyb3IiLCJzZWFyY2hDb25maWdGaWxlIiwic2VhcmNoIiwiZm9ybWF0RXJyb3JzIiwiZXJyb3JzIiwiY29uZmlnIiwib3B0cyIsImxlbmd0aCIsIlR5cGVFcnJvciIsInNjaGVtYUlkIiwianNvbiIsImZvcm1hdCIsInJlYWRDb25maWdGaWxlIiwibG9hZGVycyIsIm5vRXh0IiwicGFja2FnZVByb3AiLCJyZXN1bHQiLCJpc0VtcHR5IiwicHJldHR5IiwiY29uZmlnUmVzdWx0IiwiXyIsInJlYXNvbiIsImdldCIsIm5vcm1hbGl6ZUNvbmZpZyIsImRlbGV0ZSIsInNjaGVtYSIsIm5vcm1hbGl6ZSIsInNlY3Rpb24iLCJvYmoiLCJpc1VuZGVmaW5lZCIsIm1hcHBlZE9iaiIsIm1hcEtleXMiLCJfXyIsInByb3AiLCJwcm9wZXJ0aWVzIiwiYXBwaXVtQ2xpRGVzdCIsImNhbWVsQ2FzZSIsIm1hcFZhbHVlcyIsInZhbHVlIiwicHJvcGVydHkiLCJuZXh0U2VjdGlvbiIsImlzU2NoZW1hVHlwZU9iamVjdCIsIkJvb2xlYW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQSxTQUFTQSxVQUFULENBQXFCQyxRQUFyQixFQUErQkMsT0FBL0IsRUFBd0M7QUFDdEMsU0FBT0MsY0FBS0MsS0FBTCxDQUFXRixPQUFYLENBQVA7QUFDRDs7QUFRRCxNQUFNRyxTQUFTLEdBQUcsSUFBSUMsR0FBSixFQUFsQjs7QUFPQSxTQUFTQyxVQUFULENBQXFCTixRQUFyQixFQUErQkMs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Z0JBQUVpQixTQUFGLENBQVlQLFNBQVosRUFBdUIsQ0FBQ1EsS0FBRCxFQUFRQyxRQUFSLEtBQXFCO0FBQ2pELFlBQU1DLFdBQVcsR0FBR2IsT0FBTyxHQUFJLEdBQUVBLE9BQVEsSUFBR1ksUUFBUyxFQUExQixHQUE4QkEsUUFBekQ7QUFDQSxhQUFPRSxrQkFBa0IsQ0FBQ0gsS0FBRCxDQUFsQixHQUE0QlosU0FBUyxDQUFDckIsTUFBRCxFQUFTbUMsV0FBVCxDQUFyQyxHQUE2REYsS0FBcEU7QUFDRCxLQUhNLENBQVA7QUFJRCxHQVhEOztBQWlCQSxRQUFNRyxrQkFBa0IsR0FBSWhCLE1BQUQsSUFBWWlCLE9BQU8sQ0FBQ2pCLE1BQU0sQ0FBQ1MsVUFBUixDQUE5Qzs7QUFFQSxTQUFPUixTQUFTLENBQUNyQixNQUFELENBQWhCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCBiZXR0ZXJBanZFcnJvcnMgZnJvbSAnQHNpZHZpbmQvYmV0dGVyLWFqdi1lcnJvcnMnO1xuaW1wb3J0IHsgbGlsY29uZmlnIH0gZnJvbSAnbGlsY29uZmlnJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeWFtbCBmcm9tICd5YW1sJztcbmltcG9ydCB7IGdldFNjaGVtYSwgdmFsaWRhdGUgfSBmcm9tICcuL3NjaGVtYS9zY2hlbWEnO1xuXG4vKipcbiAqIGxpbGNvbmZpZyBsb2FkZXIgdG8gaGFuZGxlIGAueWFtbGAgZmlsZXNcbiAqIEB0eXBlIHtpbXBvcnQoJ2xpbGNvbmZpZycpLkxvYWRlclN5bmN9XG4gKi9cbmZ1bmN0aW9uIHlhbWxMb2FkZXIgKGZpbGVwYXRoLCBjb250ZW50KSB7XG4gIHJldHVybiB5YW1sLnBhcnNlKGNvbnRlbnQpO1xufVxuXG4vKipcbiAqIEEgY2FjaGUgb2YgdGhlIHJhdyBjb25maWcgZmlsZSAoYSBKU09OIHN0cmluZykgYXQgYSBmaWxlcGF0aC5cbiAqIFRoaXMgaXMgdXNlZCBmb3IgYmV0dGVyIGVycm9yIHJlcG9ydGluZy5cbiAqIE5vdGUgdGhhdCBjb25maWcgZmlsZXMgbmVlZG4ndCBiZSBKU09OLCBidXQgaXQgaGVscHMgaWYgdGhleSBhcmUuXG4gKiBAdHlwZSB7TWFwPHN0cmluZyxSYXdKc29uPn1cbiAqL1xuY29uc3QgcmF3Q29uZmlnID0gbmV3IE1hcCgpO1xuXG4vKipcbiAqIEN1c3RvbSBKU09OIGxvYWRlciB0aGF0IGNhY2hlcyB0aGUgcmF3IGNvbmZpZyBmaWxlIChmb3IgdXNlIHdpdGggYGJldHRlci1hanYtZXJyb3JzYCkuXG4gKiBJZiBpdCB3ZXJlbid0IGZvciB0aGlzIGNhY2hlLCB0aGlzIHdvdWxkIGJlIHVubmVjZXNzYXJ5LlxuICogQHR5cGUge2ltcG9ydCgnbGlsY29uZmlnJykuTG9hZGVyU3luY31cbiAqL1xuZnVuY3Rpb24ganNvbkxvYWRlciAoZmlsZXBhdGgsIGNvbnRlbnQpIHtcbiAgcmF3Q29uZmlnLnNldChmaWxlcGF0aCwgY29udGVudCk7XG4gIHJldHVybiBKU09OLnBhcnNlKGNvbnRlbnQpO1xufVxuXG4vKipcbiAqIExvYWRzIGEgY29uZmlnIGZpbGUgZnJvbSBhbiBleHBsaWNpdCBwYXRoXG4gKiBAcGFyYW0ge0xpbGNvbmZpZ0FzeW5jU2VhcmNoZXJ9IGxjIC0gbGlsY29uZmlnIGluc3RhbmNlXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZXBhdGggLSBQYXRoIHRvIGNvbmZpZyBmaWxlXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxpbXBvcnQoJ2xpbGNvbmZpZycpLkxpbGNvbmZpZ1Jlc3VsdD59XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGxvYWRDb25maWdGaWxlIChsYywgZmlsZXBhdGgpIHtcbiAgdHJ5IHtcbiAgICAvLyByZW1vdmluZyBcImF3YWl0XCIgd2lsbCBjYXVzZSBhbnkgcmVqZWN0aW9uIHRvIF9ub3RfIGJlIGNhdWdodCBpbiB0aGlzIGJsb2NrIVxuICAgIHJldHVybiBhd2FpdCBsYy5sb2FkKGZpbGVwYXRoKTtcbiAgfSBjYXRjaCAoLyoqIEB0eXBlIHt1bmtub3dufSAqL2Vycikge1xuICAgIGlmICgvKiogQHR5cGUge05vZGVKUy5FcnJub0V4Y2VwdGlvbn0gKi8oZXJyKS5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgLyoqIEB0eXBlIHtOb2RlSlMuRXJybm9FeGNlcHRpb259ICovKGVycikubWVzc2FnZSA9IGBDb25maWcgZmlsZSBub3QgZm91bmQgYXQgdXNlci1wcm92aWRlZCBwYXRoOiAke2ZpbGVwYXRofWA7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfSBlbHNlIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgLy8gZ2VuZXJhbGx5IGludmFsaWQgSlNPTlxuICAgICAgZXJyLm1lc3NhZ2UgPSBgQ29uZmlnIGZpbGUgYXQgdXNlci1wcm92aWRlZCBwYXRoICR7ZmlsZXBhdGh9IGlzIGludmFsaWQ6XFxuJHtlcnIubWVzc2FnZX1gO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuLyoqXG4gKiBTZWFyY2hlcyBmb3IgYSBjb25maWcgZmlsZVxuICogQHBhcmFtIHtMaWxjb25maWdBc3luY1NlYXJjaGVyfSBsYyAtIGxpbGNvbmZpZyBpbnN0YW5jZVxuICogQHJldHVybnMge1Byb21pc2U8aW1wb3J0KCdsaWxjb25maWcnKS5MaWxjb25maWdSZXN1bHQ+fVxuICovXG5hc3luYyBmdW5jdGlvbiBzZWFyY2hDb25maWdGaWxlIChsYykge1xuICByZXR1cm4gYXdhaXQgbGMuc2VhcmNoKCk7XG59XG5cbi8qKlxuICogR2l2ZW4gYW4gYXJyYXkgb2YgZXJyb3JzIGFuZCB0aGUgcmVzdWx0IG9mIGxvYWRpbmcgYSBjb25maWcgZmlsZSwgZ2VuZXJhdGUgYVxuICogaGVscGZ1bCBzdHJpbmcgZm9yIHRoZSB1c2VyLlxuICpcbiAqIC0gSWYgYG9wdHNgIGNvbnRhaW5zIGEgYGpzb25gIHByb3BlcnR5LCB0aGlzIHNob3VsZCBiZSB0aGUgb3JpZ2luYWwgSlNPTlxuICogICBfc3RyaW5nXyBvZiB0aGUgY29uZmlnIGZpbGUuICBUaGlzIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB0aGUgY29uZmlnIGZpbGVcbiAqICAgd2FzIGluIEpTT04gZm9ybWF0LiBJZiBwcmVzZW50LCBpdCB3aWxsIGFzc29jaWF0ZSBsaW5lIG51bWJlcnMgd2l0aCBlcnJvcnMuXG4gKiAtIElmIGBlcnJvcnNgIGhhcHBlbnMgdG8gYmUgZW1wdHksIHRoaXMgd2lsbCB0aHJvdy5cbiAqIEBwYXJhbSB7aW1wb3J0KCdhanYnKS5FcnJvck9iamVjdFtdfSBlcnJvcnMgLSBOb24tZW1wdHkgYXJyYXkgb2YgZXJyb3JzLiBSZXF1aXJlZC5cbiAqIEBwYXJhbSB7UmVhZENvbmZpZ0ZpbGVSZXN1bHRbJ2NvbmZpZyddfGFueX0gW2NvbmZpZ10gLVxuICogQ29uZmlndXJhdGlvbiAmIG1ldGFkYXRhXG4gKiBAcGFyYW0ge0Zvcm1hdENvbmZpZ0Vycm9yc09wdGlvbnN9IFtvcHRzXVxuICogQHRocm93cyB7VHlwZUVycm9yfSBJZiBgZXJyb3JzYCBpcyBlbXB0eVxuICogQHJldHVybnMge3N0cmluZ31cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdEVycm9ycyAoZXJyb3JzID0gW10sIGNvbmZpZyA9IHt9LCBvcHRzID0ge30pIHtcbiAgaWYgKGVycm9ycyAmJiAhZXJyb3JzLmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FycmF5IG9mIGVycm9ycyBtdXN0IGJlIG5vbi1lbXB0eScpO1xuICB9XG4gIHJldHVybiBiZXR0ZXJBanZFcnJvcnMoZ2V0U2NoZW1hKG9wdHMuc2NoZW1hSWQpLCBjb25maWcsIGVycm9ycywge1xuICAgIGpzb246IG9wdHMuanNvbixcbiAgICBmb3JtYXQ6ICdjbGknLFxuICB9KTtcbn1cblxuLyoqXG4gKiBHaXZlbiBhbiBvcHRpb25hbCBwYXRoLCByZWFkIGEgY29uZmlnIGZpbGUuIFZhbGlkYXRlcyB0aGUgY29uZmlnIGZpbGUuXG4gKlxuICogQ2FsbCB7QGxpbmsgdmFsaWRhdGV9IGlmIHlvdSBhbHJlYWR5IGhhdmUgYSBjb25maWcgb2JqZWN0LlxuICogQHBhcmFtIHtzdHJpbmd9IFtmaWxlcGF0aF0gLSBQYXRoIHRvIGNvbmZpZyBmaWxlLCBpZiB3ZSBoYXZlIG9uZVxuICogQHBhcmFtIHtSZWFkQ29uZmlnRmlsZU9wdGlvbnN9IFtvcHRzXSAtIE9wdGlvbnNcbiAqIEBwdWJsaWNcbiAqIEByZXR1cm5zIHtQcm9taXNlPFJlYWRDb25maWdGaWxlUmVzdWx0Pn0gQ29udGFpbnMgY29uZmlnIGFuZCBmaWxlcGF0aCwgaWYgZm91bmQsIGFuZCBhbnkgZXJyb3JzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWFkQ29uZmlnRmlsZSAoZmlsZXBhdGgsIG9wdHMgPSB7fSkge1xuICBjb25zdCBsYyA9IGxpbGNvbmZpZygnYXBwaXVtJywge1xuICAgIGxvYWRlcnM6IHtcbiAgICAgICcueWFtbCc6IHlhbWxMb2FkZXIsXG4gICAgICAnLnltbCc6IHlhbWxMb2FkZXIsXG4gICAgICAnLmpzb24nOiBqc29uTG9hZGVyLFxuICAgICAgbm9FeHQ6IGpzb25Mb2FkZXIsXG4gICAgfSxcbiAgICBwYWNrYWdlUHJvcDogJ2FwcGl1bUNvbmZpZydcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gZmlsZXBhdGhcbiAgICA/IGF3YWl0IGxvYWRDb25maWdGaWxlKGxjLCBmaWxlcGF0aClcbiAgICA6IGF3YWl0IHNlYXJjaENvbmZpZ0ZpbGUobGMpO1xuXG4gIGlmIChyZXN1bHQ/LmZpbGVwYXRoICYmICFyZXN1bHQ/LmlzRW1wdHkpIHtcbiAgICBjb25zdCB7cHJldHR5ID0gdHJ1ZX0gPSBvcHRzO1xuICAgIHRyeSB7XG4gICAgICBsZXQgY29uZmlnUmVzdWx0O1xuICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGUocmVzdWx0LmNvbmZpZyk7XG4gICAgICBpZiAoXy5pc0VtcHR5KGVycm9ycykpIHtcbiAgICAgICAgY29uZmlnUmVzdWx0ID0gey4uLnJlc3VsdCwgZXJyb3JzfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlYXNvbiA9IGZvcm1hdEVycm9ycyhlcnJvcnMsIHJlc3VsdC5jb25maWcsIHtcbiAgICAgICAgICBqc29uOiByYXdDb25maWcuZ2V0KHJlc3VsdC5maWxlcGF0aCksXG4gICAgICAgICAgcHJldHR5LFxuICAgICAgICB9KTtcbiAgICAgICAgY29uZmlnUmVzdWx0ID0gcmVhc29uXG4gICAgICAgICAgPyB7Li4ucmVzdWx0LCBlcnJvcnMsIHJlYXNvbn1cbiAgICAgICAgICA6IHsuLi5yZXN1bHQsIGVycm9yc307XG4gICAgICB9XG5cbiAgICAgIC8vIG5vcm1hbGl6ZSAodG8gY2FtZWwgY2FzZSkgYWxsIHRvcC1sZXZlbCBwcm9wZXJ0eSBuYW1lcyBvZiB0aGUgY29uZmlnIGZpbGVcbiAgICAgIGNvbmZpZ1Jlc3VsdC5jb25maWcgPSBub3JtYWxpemVDb25maWcoXG4gICAgICAgIC8qKiBAdHlwZSB7QXBwaXVtQ29uZmlnfSAqLyAoY29uZmlnUmVzdWx0LmNvbmZpZyksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gY29uZmlnUmVzdWx0O1xuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyBjbGVhbiB1cCB0aGUgcmF3IGNvbmZpZyBmaWxlIGNhY2hlLCB3aGljaCBpcyBvbmx5IGtlcHQgdG8gYmV0dGVyIHJlcG9ydCBlcnJvcnMuXG4gICAgICByYXdDb25maWcuZGVsZXRlKHJlc3VsdC5maWxlcGF0aCk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHQgPz8ge307XG59XG5cbi8qKlxuICogQ29udmVydCBzY2hlbWEgcHJvcGVydHkgbmFtZXMgdG8gZWl0aGVyIGEpIHRoZSB2YWx1ZSBvZiB0aGUgYGFwcGl1bUNsaURlc3RgIHByb3BlcnR5LCBpZiBhbnk7IG9yIGIpIGNhbWVsLWNhc2VcbiAqIEBwYXJhbSB7QXBwaXVtQ29uZmlnfSBjb25maWcgLSBDb25maWd1cmF0aW9uIG9iamVjdFxuICogQHJldHVybnMge05vcm1hbGl6ZWRBcHBpdW1Db25maWd9IE5ldyBvYmplY3Qgd2l0aCBjYW1lbC1jYXNlZCBrZXlzIChvciBgZGVzdGAga2V5cykuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVDb25maWcgKGNvbmZpZykge1xuICBjb25zdCBzY2hlbWEgPSBnZXRTY2hlbWEoKTtcbiAgLyoqXG4gICAqIEBwYXJhbSB7QXBwaXVtQ29uZmlnfSBjb25maWdcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtzZWN0aW9uXSAtIEtleXBhdGggKGxvZGFzaCBgXy5nZXQoKWAgc3R5bGUpIHRvIHNlY3Rpb24gb2YgY29uZmlnLiBJZiBvbWl0dGVkLCBhc3N1bWUgcm9vdCBBcHBpdW0gY29uZmlnIHNjaGVtYVxuICAgKiBAdG9kbyBSZXdyaXRlIGFzIGEgbG9vcFxuICAgKiBAcmV0dXJucyBOb3JtYWxpemVkIHNlY3Rpb24gb2YgY29uZmlnXG4gICAqL1xuICBjb25zdCBub3JtYWxpemUgPSAoY29uZmlnLCBzZWN0aW9uKSA9PiB7XG4gICAgY29uc3Qgb2JqID0gXy5pc1VuZGVmaW5lZChzZWN0aW9uKSA/IGNvbmZpZyA6IF8uZ2V0KGNvbmZpZywgc2VjdGlvbiwgY29uZmlnKTtcblxuICAgIGNvbnN0IG1hcHBlZE9iaiA9IF8ubWFwS2V5cyhvYmosIChfXywgcHJvcCkgPT5cbiAgICAgIHNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BdPy5hcHBpdW1DbGlEZXN0ID8/IF8uY2FtZWxDYXNlKHByb3ApLFxuICAgICk7XG5cbiAgICByZXR1cm4gXy5tYXBWYWx1ZXMobWFwcGVkT2JqLCAodmFsdWUsIHByb3BlcnR5KSA9PiB7XG4gICAgICBjb25zdCBuZXh0U2VjdGlvbiA9IHNlY3Rpb24gPyBgJHtzZWN0aW9ufS4ke3Byb3BlcnR5fWAgOiBwcm9wZXJ0eTtcbiAgICAgIHJldHVybiBpc1NjaGVtYVR5cGVPYmplY3QodmFsdWUpID8gbm9ybWFsaXplKGNvbmZpZywgbmV4dFNlY3Rpb24pIDogdmFsdWU7XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBzY2hlbWEgcHJvcCByZWZlcmVuY2VzIGFuIG9iamVjdCwgb3IgaWYgaXQncyBhbiBvYmplY3QgaXRzZWxmXG4gICAqIEBwYXJhbSB7aW1wb3J0KCdhanYnKS5TY2hlbWFPYmplY3R8b2JqZWN0fSBzY2hlbWEgLSBSZWZlcmVuY2luZyBzY2hlbWEgb2JqZWN0XG4gICAqL1xuICBjb25zdCBpc1NjaGVtYVR5cGVPYmplY3QgPSAoc2NoZW1hKSA9PiBCb29sZWFuKHNjaGVtYS5wcm9wZXJ0aWVzKTtcblxuICByZXR1cm4gbm9ybWFsaXplKGNvbmZpZyk7XG59XG5cbi8qKlxuICogUmVzdWx0IG9mIGNhbGxpbmcge0BsaW5rIHJlYWRDb25maWdGaWxlfS5cbiAqIEB0eXBlZGVmIFJlYWRDb25maWdGaWxlUmVzdWx0XG4gKiBAcHJvcGVydHkge2ltcG9ydCgnYWp2JykuRXJyb3JPYmplY3RbXX0gW2Vycm9yc10gLSBWYWxpZGF0aW9uIGVycm9yc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtmaWxlcGF0aF0gLSBUaGUgcGF0aCB0byB0aGUgY29uZmlnIGZpbGUsIGlmIGZvdW5kXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtpc0VtcHR5XSAtIElmIGB0cnVlYCwgdGhlIGNvbmZpZyBmaWxlIGV4aXN0cyBidXQgaXMgZW1wdHlcbiAqIEBwcm9wZXJ0eSB7Tm9ybWFsaXplZEFwcGl1bUNvbmZpZ30gW2NvbmZpZ10gLSBUaGUgcGFyc2VkIGNvbmZpZ3VyYXRpb25cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfGltcG9ydCgnQHNpZHZpbmQvYmV0dGVyLWFqdi1lcnJvcnMnKS5JT3V0cHV0RXJyb3JbXX0gW3JlYXNvbl0gLSBIdW1hbi1yZWFkYWJsZSBlcnJvciBtZXNzYWdlcyBhbmQgc3VnZ2VzdGlvbnMuIElmIHRoZSBgcHJldHR5YCBvcHRpb24gaXMgYHRydWVgLCB0aGlzIHdpbGwgYmUgYSBuaWNlIHN0cmluZyB0byBwcmludC5cbiAqL1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHtAbGluayByZWFkQ29uZmlnRmlsZX0uXG4gKiBAdHlwZWRlZiBSZWFkQ29uZmlnRmlsZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3ByZXR0eT10cnVlXSBJZiBgZmFsc2VgLCBkbyBub3QgdXNlIGNvbG9yIGFuZCBmYW5jeSBmb3JtYXR0aW5nIGluIHRoZSBgcmVhc29uYCBwcm9wZXJ0eSBvZiB0aGUge0BsaW5rIFJlYWRDb25maWdGaWxlUmVzdWx0fS4gVGhlIHZhbHVlIG9mIGByZWFzb25gIGlzIHRoZW4gc3VpdGFibGUgZm9yIG1hY2hpbmUtcmVhZGluZy5cbiAqL1xuXG4vKipcbiAqIFRoaXMgaXMgYW4gYEFzeW5jU2VhcmNoZXJgIHdoaWNoIGlzIGluZXhwbGljYWJseSBfbm90XyBleHBvcnRlZCBieSB0aGUgYGxpbGNvbmZpZ2AgdHlwZSBkZWZpbml0aW9uLlxuICogQHR5cGVkZWYge1JldHVyblR5cGU8aW1wb3J0KCdsaWxjb25maWcnKVtcImxpbGNvbmZpZ1wiXT59IExpbGNvbmZpZ0FzeW5jU2VhcmNoZXJcbiAqL1xuXG4vKipcbiAqIFRoZSBjb250ZW50cyBvZiBhbiBBcHBpdW0gY29uZmlnIGZpbGUuIEdlbmVyYXRlZCBmcm9tIHNjaGVtYVxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkFwcGl1bUNvbmZpZ30gQXBwaXVtQ29uZmlnXG4gKi9cblxuLyoqXG4gKiBUaGUgY29udGVudHMgb2YgYW4gQXBwaXVtIGNvbmZpZyBmaWxlIHdpdGggY2FtZWxjYXNlZCBwcm9wZXJ0eSBuYW1lcyAoYW5kIHVzaW5nIGBhcHBpdW1DbGlEZXN0YCB2YWx1ZSBpZiBwcmVzZW50KS4gR2VuZXJhdGVkIGZyb20ge0BsaW5rIEFwcGl1bUNvbmZpZ31cbiAqIEB0eXBlZGVmIHtpbXBvcnQoJ0BhcHBpdW0vdHlwZXMnKS5Ob3JtYWxpemVkQXBwaXVtQ29uZmlnfSBOb3JtYWxpemVkQXBwaXVtQ29uZmlnXG4gKi9cblxuLyoqXG4gKiBUaGUgc3RyaW5nIHNob3VsZCBiZSBhIHJhdyBKU09OIHN0cmluZy5cbiAqIEB0eXBlZGVmIHtzdHJpbmd9IFJhd0pzb25cbiAqL1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHtAbGluayBmb3JtYXRFcnJvcnN9LlxuICogQHR5cGVkZWYgRm9ybWF0Q29uZmlnRXJyb3JzT3B0aW9uc1xuICogQHByb3BlcnR5IHtpbXBvcnQoJy4vY29uZmlnLWZpbGUnKS5SYXdKc29ufSBbanNvbl0gLSBSYXcgSlNPTiBjb25maWcgKGFzIHN0cmluZylcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3ByZXR0eT10cnVlXSAtIFdoZXRoZXIgdG8gZm9ybWF0IGVycm9ycyBhcyBhIENMSS1mcmllbmRseSBzdHJpbmdcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAgW3NjaGVtYUlkXSAtIFNwZWNpZmljIElEIG9mIGEgcHJvcDsgb3RoZXJ3aXNlIGVudGlyZSBzY2hlbWFcbiAqL1xuIl19