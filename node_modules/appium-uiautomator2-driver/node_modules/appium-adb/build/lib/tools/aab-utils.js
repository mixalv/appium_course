"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger.js"));

var _path = _interopRequireDefault(require("path"));

var _support = require("@appium/support");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _helpers = require("../helpers.js");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _crypto = _interopRequireDefault(require("crypto"));

const AAB_CACHE = new _lruCache.default({
  max: 10,
  dispose: (hash, extractedFilesRoot) => _support.fs.rimraf(extractedFilesRoot)
});
const AAB_CACHE_GUARD = new _asyncLock.default();
const UNIVERSAL_APK = 'universal.apk';
const aabUtilsMethods = {};
process.on('exit', () => {
  if (!AAB_CACHE.size) {
    return;
  }

  const paths = [...AAB_CACHE.values()];

  _logger.default.debug(`Performing cleanup of ${paths.length} cached .aab ` + _support.util.pluralize('package', paths.length));

  for (const appPath of paths) {
    try {
      _support.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});

aabUtilsMethods.extractUniversalApk = async function extractUniversalApk(aabPath, opts = {}) {
  if (!(await _support.fs.exists(aabPath))) {
    throw new Error(`The file at '${aabPath}' either does not exist or is not accessible`);
  }

  const aabName = _path.default.basename(aabPath);

  const apkName = aabName.substring(0, aabName.length - _path.default.extname(aabName).length) + '.apk';
  const tmpRoot = await _support.tempDir.openDir();

  const tmpApksPath = _path.default.join(tmpRoot, `${aabName}.apks`);

  try {
    return await AAB_CACHE_GUARD.acquire(aabPath, async () => {
      const aabHash = await _support.fs.hash(aabPath);
      const {
        keystore,
        keystorePassword,
        keyAlias,
        keyPassword
      } = opts;
      let cacheHash = aabHash;

      if (keystore) {
        if (!(await _support.fs.exists(keystore))) {
          throw new Error(`The keystore file at '${keystore}' either does not exist ` + `or is not accessible`);
        }

        if (!keystorePassword || !keyAlias || !keyPassword) {
          throw new Error('It is mandatory to also provide keystore password, key alias, ' + 'and key password if the keystore path is set');
        }

        const keystoreHash = await _support.fs.hash(keystore);

        const keyAliasHash = _crypto.default.createHash('sha1');

        keyAliasHash.update(keyAlias);
        cacheHash = [cacheHash, keystoreHash, keyAliasHash.digest('hex')].join(':');
      }

      _logger.default.debug(`Calculated the cache key for '${aabPath}': ${cacheHash}`);

      if (AAB_CACHE.has(cacheHash)) {
        const resultPath = _path.default.resolve(AAB_CACHE.get(cacheHash), apkName);

        if (await _support.fs.exists(resultPath)) {
          return resultPath;
        }

        AAB_CACHE.del(cacheHash);
      }

      await this.initAapt2();
      const args = ['build-apks', '--aapt2', this.binaries.aapt2, '--bundle', aabPath, '--output', tmpApksPath, ...(keystore ? ['--ks', keystore, '--ks-pass', `pass:${keystorePassword}`, '--ks-key-alias', keyAlias, '--key-pass', `pass:${keyPassword}`] : []), '--mode=universal'];

      _logger.default.debug(`Preparing universal .apks bundle from '${aabPath}'`);

      await this.execBundletool(args, `Cannot build a universal .apks bundle from '${aabPath}'`);

      _logger.default.debug(`Unpacking universal application bundle at '${tmpApksPath}' to '${tmpRoot}'`);

      await (0, _helpers.unzipFile)(tmpApksPath, tmpRoot);
      let universalApkPath;
      const fileDeletionPromises = [];
      const allFileNames = await _support.fs.readdir(tmpRoot);

      for (const fileName of allFileNames) {
        const fullPath = _path.default.join(tmpRoot, fileName);

        if (fileName === UNIVERSAL_APK) {
          universalApkPath = fullPath;
        } else {
          fileDeletionPromises.push(_support.fs.rimraf(fullPath));
        }
      }

      try {
        await _bluebird.default.all(fileDeletionPromises);
      } catch (ign) {}

      if (!universalApkPath) {
        _logger.default.debug(`The following items were extracted from the .aab bundle: ${allFileNames}`);

        throw new Error(`${UNIVERSAL_APK} cannot be found in '${aabPath}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }

      const resultPath = _path.default.join(tmpRoot, apkName);

      _logger.default.debug(`Found ${UNIVERSAL_APK} at '${universalApkPath}'. Caching it to '${resultPath}'`);

      await _support.fs.mv(universalApkPath, resultPath);
      AAB_CACHE.set(cacheHash, tmpRoot);
      return resultPath;
    });
  } catch (e) {
    await _support.fs.rimraf(tmpRoot);
    throw e;
  }
};

var _default = aabUtilsMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hYWItdXRpbHMuanMiXSwibmFtZXMiOlsiQUFCX0NBQ0hFIiwiTFJVIiwibWF4IiwiZGlzcG9zZSIsImhhc2giLCJleHRyYWN0ZWRGaWxlc1Jvb3QiLCJmcyIsInJpbXJhZiIsIkFBQl9DQUNIRV9HVUFSRCIsIkFzeW5jTG9jayIsIlVOSVZFUlNBTF9BUEsiLCJhYWJVdGlsc01ldGhvZHMiLCJwcm9jZXNzIiwib24iLCJzaXplIiwicGF0aHMiLCJ2YWx1ZXMiLCJsb2ciLCJkZWJ1ZyIsImxlbmd0aCIsInV0aWwiLCJwbHVyYWxpemUiLCJhcHBQYXRoIiwicmltcmFmU3luYyIsImUiLCJ3YXJuIiwibWVzc2FnZSIsImV4dHJhY3RVbml2ZXJzYWxBcGsiLCJhYWJQYXRoIiwib3B0cyIsImV4aXN0cyIsIkVycm9yIiwiYWFiTmFtZSIsInBhdGgiLCJiYXNlbmFtZSIsImFwa05hbWUiLCJzdWJzdHJpbmciLCJleHRuYW1lIiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwidG1wQXBrc1BhdGgiLCJqb2luIiwiYWNxdWlyZSIsImFhYkhhc2giLCJrZXlzdG9yZSIsImtleXN0b3JlUGFzc3dvcmQiLCJrZXlBbGlhcyIsImtleVBhc3N3b3JkIiwiY2FjaGVIYXNoIiwia2V5c3RvcmVIYXNoIiwia2V5QWxpYXNIYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImhhcyIsInJlc3VsdFBhdGgiLCJyZXNvbHZlIiwiZ2V0IiwiZGVsIiwiaW5pdEFhcHQyIiwiYXJncyIsImJpbmFyaWVzIiwiYWFwdDIiLCJleGVjQnVuZGxldG9vbCIsInVuaXZlcnNhbEFwa1BhdGgiLCJmaWxlRGVsZXRpb25Qcm9taXNlcyIsImFsbEZpbGVOYW1lcyIsInJlYWRkaXIiLCJmaWxlTmFtZSIsImZ1bGxQYXRoIiwicHVzaCIsIkIiLCJhbGwiLCJpZ24iLCJtdiIsInNldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFD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QlQsVUFBVyxHQUF4Rjs7QUFDQSxZQUFNbkQsWUFBR3NFLEVBQUgsQ0FBTVYsZ0JBQU4sRUFBd0JULFVBQXhCLENBQU47QUFDQXpELE1BQUFBLFNBQVMsQ0FBQzZFLEdBQVYsQ0FBYzVCLFNBQWQsRUFBeUJYLE9BQXpCO0FBQ0EsYUFBT21CLFVBQVA7QUFDRCxLQTNFWSxDQUFiO0FBNEVELEdBN0VELENBNkVFLE9BQU9qQyxDQUFQLEVBQVU7QUFDVixVQUFNbEIsWUFBR0MsTUFBSCxDQUFVK0IsT0FBVixDQUFOO0FBQ0EsVUFBTWQsQ0FBTjtBQUNEO0FBQ0YsQ0ExRkQ7O2VBNEZlYixlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXIuanMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgdGVtcERpciwgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgeyB1bnppcEZpbGUgfSBmcm9tICcuLi9oZWxwZXJzLmpzJztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5cbmNvbnN0IEFBQl9DQUNIRSA9IG5ldyBMUlUoe1xuICBtYXg6IDEwLFxuICBkaXNwb3NlOiAoaGFzaCwgZXh0cmFjdGVkRmlsZXNSb290KSA9PiBmcy5yaW1yYWYoZXh0cmFjdGVkRmlsZXNSb290KSxcbn0pO1xuY29uc3QgQUFCX0NBQ0hFX0dVQVJEID0gbmV3IEFzeW5jTG9jaygpO1xuY29uc3QgVU5JVkVSU0FMX0FQSyA9ICd1bml2ZXJzYWwuYXBrJztcblxuY29uc3QgYWFiVXRpbHNNZXRob2RzID0ge307XG5cbnByb2Nlc3Mub24oJ2V4aXQnLCAoKSA9PiB7XG4gIGlmICghQUFCX0NBQ0hFLnNpemUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBwYXRocyA9IFsuLi5BQUJfQ0FDSEUudmFsdWVzKCldO1xuICBsb2cuZGVidWcoYFBlcmZvcm1pbmcgY2xlYW51cCBvZiAke3BhdGhzLmxlbmd0aH0gY2FjaGVkIC5hYWIgYCArXG4gICAgdXRpbC5wbHVyYWxpemUoJ3BhY2thZ2UnLCBwYXRocy5sZW5ndGgpKTtcbiAgZm9yIChjb25zdCBhcHBQYXRoIG9mIHBhdGhzKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEFzeW5jaHJvbm91cyBjYWxscyBhcmUgbm90IHN1cHBvcnRlZCBpbiBvbkV4aXQgaGFuZGxlclxuICAgICAgZnMucmltcmFmU3luYyhhcHBQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihlLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxufSk7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQXBrQ3JlYXRpb25PcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5c3RvcmUgU3BlY2lmaWVzIHRoZSBwYXRoIHRvIHRoZSBkZXBsb3ltZW50IGtleXN0b3JlIHVzZWRcbiAqIHRvIHNpZ24gdGhlIEFQS3MuIFRoaXMgZmxhZyBpcyBvcHRpb25hbC4gSWYgeW91IGRvbid0IGluY2x1ZGUgaXQsXG4gKiBidW5kbGV0b29sIGF0dGVtcHRzIHRvIHNpZ24geW91ciBBUEtzIHdpdGggYSBkZWJ1ZyBzaWduaW5nIGtleS5cbiAqIElmIHRoZSAuYXBrIGhhcyBiZWVuIGFscmVhZHkgc2lnbmVkIGFuZCBjYWNoZWQgdGhlbiBpdCBpcyBub3QgZ29pbmcgdG8gYmUgcmVzaWduZWRcbiAqIHVubGVzcyBhIGRpZmZlcmVudCBrZXlzdG9yZSBvciBrZXkgYWxpYXMgaXMgdXNlZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlzdG9yZVBhc3N3b3JkIFNwZWNpZmllcyB5b3VyIGtleXN0b3Jl4oCZcyBwYXNzd29yZC5cbiAqIEl0IGlzIG1hbmRhdG9yeSB0byBwcm92aWRlIHRoaXMgdmFsdWUgaWYgYGtleXN0b3JlYCBvbmUgaXMgYXNzaWduZWRcbiAqIG90aGVyd2lzZSBpdCBpcyBnb2luZyB0byBiZSBpZ25vcmVkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleUFsaWFzIFNwZWNpZmllcyB0aGUgYWxpYXMgb2YgdGhlIHNpZ25pbmcga2V5IHlvdSB3YW50IHRvIHVzZS5cbiAqIEl0IGlzIG1hbmRhdG9yeSB0byBwcm92aWRlIHRoaXMgdmFsdWUgaWYgYGtleXN0b3JlYCBvbmUgaXMgYXNzaWduZWRcbiAqIG90aGVyd2lzZSBpdCBpcyBnb2luZyB0byBiZSBpZ25vcmVkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleVBhc3N3b3JkIFNwZWNpZmllcyB0aGUgcGFzc3dvcmQgZm9yIHRoZSBzaWduaW5nIGtleS5cbiAqIEl0IGlzIG1hbmRhdG9yeSB0byBwcm92aWRlIHRoaXMgdmFsdWUgaWYgYGtleXN0b3JlYCBvbmUgaXMgYXNzaWduZWRcbiAqIG90aGVyd2lzZSBpdCBpcyBnb2luZyB0byBiZSBpZ25vcmVkLlxuICovXG5cbi8qKlxuICogQnVpbGRzIGEgdW5pdmVyc2FsIC5hcGsgZnJvbSB0aGUgZ2l2ZW4gLmFhYiBwYWNrYWdlLiBTZWVcbiAqIGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3N0dWRpby9jb21tYW5kLWxpbmUvYnVuZGxldG9vbCNnZW5lcmF0ZV9hcGtzXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhYWJQYXRoIEZ1bGwgcGF0aCB0byB0aGUgc291cmNlIC5hYWIgcGFja2FnZVxuICogQHBhcmFtIHtBcGtDcmVhdGlvbk9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm5zIFRoZSBwYXRoIHRvIHRoZSByZXN1bHRpbmcgdW5pdmVyc2FsIC5hcGsuIFRoZSAuYXBrIGlzIHN0b3JlZCBpbiB0aGUgaW50ZXJuYWwgY2FjaGVcbiAqIGJ5IGRlZmF1bHQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGNyZWF0aW5nIHRoZSB1bml2ZXJzYWwgLmFwa1xuICovXG5hYWJVdGlsc01ldGhvZHMuZXh0cmFjdFVuaXZlcnNhbEFwayA9IGFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RVbml2ZXJzYWxBcGsgKGFhYlBhdGgsIG9wdHMgPSB7fSkge1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhhYWJQYXRoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGZpbGUgYXQgJyR7YWFiUGF0aH0nIGVpdGhlciBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG5cbiAgY29uc3QgYWFiTmFtZSA9IHBhdGguYmFzZW5hbWUoYWFiUGF0aCk7XG4gIGNvbnN0IGFwa05hbWUgPSBhYWJOYW1lLnN1YnN0cmluZygwLCBhYWJOYW1lLmxlbmd0aCAtIHBhdGguZXh0bmFtZShhYWJOYW1lKS5sZW5ndGgpICsgJy5hcGsnO1xuICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGNvbnN0IHRtcEFwa3NQYXRoID0gcGF0aC5qb2luKHRtcFJvb3QsIGAke2FhYk5hbWV9LmFwa3NgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgQUFCX0NBQ0hFX0dVQVJELmFjcXVpcmUoYWFiUGF0aCwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWFiSGFzaCA9IGF3YWl0IGZzLmhhc2goYWFiUGF0aCk7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGtleXN0b3JlLFxuICAgICAgICBrZXlzdG9yZVBhc3N3b3JkLFxuICAgICAgICBrZXlBbGlhcyxcbiAgICAgICAga2V5UGFzc3dvcmQsXG4gICAgICB9ID0gb3B0cztcbiAgICAgIGxldCBjYWNoZUhhc2ggPSBhYWJIYXNoO1xuICAgICAgaWYgKGtleXN0b3JlKSB7XG4gICAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGtleXN0b3JlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGtleXN0b3JlIGZpbGUgYXQgJyR7a2V5c3RvcmV9JyBlaXRoZXIgZG9lcyBub3QgZXhpc3QgYCArXG4gICAgICAgICAgICBgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWtleXN0b3JlUGFzc3dvcmQgfHwgIWtleUFsaWFzIHx8ICFrZXlQYXNzd29yZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSXQgaXMgbWFuZGF0b3J5IHRvIGFsc28gcHJvdmlkZSBrZXlzdG9yZSBwYXNzd29yZCwga2V5IGFsaWFzLCAnICtcbiAgICAgICAgICAgICdhbmQga2V5IHBhc3N3b3JkIGlmIHRoZSBrZXlzdG9yZSBwYXRoIGlzIHNldCcpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGtleXN0b3JlSGFzaCA9IGF3YWl0IGZzLmhhc2goa2V5c3RvcmUpO1xuICAgICAgICBjb25zdCBrZXlBbGlhc0hhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuICAgICAgICBrZXlBbGlhc0hhc2gudXBkYXRlKGtleUFsaWFzKTtcbiAgICAgICAgY2FjaGVIYXNoID0gW2NhY2hlSGFzaCwga2V5c3RvcmVIYXNoLCBrZXlBbGlhc0hhc2guZGlnZXN0KCdoZXgnKV0uam9pbignOicpO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBDYWxjdWxhdGVkIHRoZSBjYWNoZSBrZXkgZm9yICcke2FhYlBhdGh9JzogJHtjYWNoZUhhc2h9YCk7XG4gICAgICBpZiAoQUFCX0NBQ0hFLmhhcyhjYWNoZUhhc2gpKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLnJlc29sdmUoQUFCX0NBQ0hFLmdldChjYWNoZUhhc2gpLCBhcGtOYW1lKTtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgICAgICAgIHJldHVybiByZXN1bHRQYXRoO1xuICAgICAgICB9XG4gICAgICAgIEFBQl9DQUNIRS5kZWwoY2FjaGVIYXNoKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5pbml0QWFwdDIoKTtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAgICdidWlsZC1hcGtzJyxcbiAgICAgICAgJy0tYWFwdDInLCB0aGlzLmJpbmFyaWVzLmFhcHQyLFxuICAgICAgICAnLS1idW5kbGUnLCBhYWJQYXRoLFxuICAgICAgICAnLS1vdXRwdXQnLCB0bXBBcGtzUGF0aCxcbiAgICAgICAgLi4uKGtleXN0b3JlID8gW1xuICAgICAgICAgICctLWtzJywga2V5c3RvcmUsXG4gICAgICAgICAgJy0ta3MtcGFzcycsIGBwYXNzOiR7a2V5c3RvcmVQYXNzd29yZH1gLFxuICAgICAgICAgICctLWtzLWtleS1hbGlhcycsIGtleUFsaWFzLFxuICAgICAgICAgICctLWtleS1wYXNzJywgYHBhc3M6JHtrZXlQYXNzd29yZH1gLFxuICAgICAgICBdIDogW10pLFxuICAgICAgICAnLS1tb2RlPXVuaXZlcnNhbCdcbiAgICAgIF07XG4gICAgICBsb2cuZGVidWcoYFByZXBhcmluZyB1bml2ZXJzYWwgLmFwa3MgYnVuZGxlIGZyb20gJyR7YWFiUGF0aH0nYCk7XG4gICAgICBhd2FpdCB0aGlzLmV4ZWNCdW5kbGV0b29sKGFyZ3MsIGBDYW5ub3QgYnVpbGQgYSB1bml2ZXJzYWwgLmFwa3MgYnVuZGxlIGZyb20gJyR7YWFiUGF0aH0nYCk7XG5cbiAgICAgIGxvZy5kZWJ1ZyhgVW5wYWNraW5nIHVuaXZlcnNhbCBhcHBsaWNhdGlvbiBidW5kbGUgYXQgJyR7dG1wQXBrc1BhdGh9JyB0byAnJHt0bXBSb290fSdgKTtcbiAgICAgIGF3YWl0IHVuemlwRmlsZSh0bXBBcGtzUGF0aCwgdG1wUm9vdCk7XG4gICAgICBsZXQgdW5pdmVyc2FsQXBrUGF0aDtcbiAgICAgIGNvbnN0IGZpbGVEZWxldGlvblByb21pc2VzID0gW107XG4gICAgICBjb25zdCBhbGxGaWxlTmFtZXMgPSBhd2FpdCBmcy5yZWFkZGlyKHRtcFJvb3QpO1xuICAgICAgZm9yIChjb25zdCBmaWxlTmFtZSBvZiBhbGxGaWxlTmFtZXMpIHtcbiAgICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgZmlsZU5hbWUpO1xuICAgICAgICBpZiAoZmlsZU5hbWUgPT09IFVOSVZFUlNBTF9BUEspIHtcbiAgICAgICAgICB1bml2ZXJzYWxBcGtQYXRoID0gZnVsbFBhdGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZmlsZURlbGV0aW9uUHJvbWlzZXMucHVzaChmcy5yaW1yYWYoZnVsbFBhdGgpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgQi5hbGwoZmlsZURlbGV0aW9uUHJvbWlzZXMpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgaWYgKCF1bml2ZXJzYWxBcGtQYXRoKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVGhlIGZvbGxvd2luZyBpdGVtcyB3ZXJlIGV4dHJhY3RlZCBmcm9tIHRoZSAuYWFiIGJ1bmRsZTogJHthbGxGaWxlTmFtZXN9YCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtVTklWRVJTQUxfQVBLfSBjYW5ub3QgYmUgZm91bmQgaW4gJyR7YWFiUGF0aH0nIGJ1bmRsZS4gYCArXG4gICAgICAgICAgYERvZXMgdGhlIGFyY2hpdmUgY29udGFpbiBhIHZhbGlkIGFwcGxpY2F0aW9uIGJ1bmRsZT9gKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgYXBrTmFtZSk7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kICR7VU5JVkVSU0FMX0FQS30gYXQgJyR7dW5pdmVyc2FsQXBrUGF0aH0nLiBDYWNoaW5nIGl0IHRvICcke3Jlc3VsdFBhdGh9J2ApO1xuICAgICAgYXdhaXQgZnMubXYodW5pdmVyc2FsQXBrUGF0aCwgcmVzdWx0UGF0aCk7XG4gICAgICBBQUJfQ0FDSEUuc2V0KGNhY2hlSGFzaCwgdG1wUm9vdCk7XG4gICAgICByZXR1cm4gcmVzdWx0UGF0aDtcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB0aHJvdyBlO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhYWJVdGlsc01ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hYWItdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
